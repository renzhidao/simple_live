name: Android CI

on:
  push:
    branches: [ master ]
    paths:
      - 'simple_live_app/**'
      - '.github/workflows/android_build.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.x'   # 固定一个稳定小版本，避免 SDK 漂移
          cache: true

      # 可选：需要带签名的 release 再启用这两步（否则会构建未签名 release）
      # - name: Generate debug keystore
      #   working-directory: simple_live_app/android/app
      #   run: |
      #     keytool -genkey -v \
      #       -keystore debug.keystore -storetype JKS \
      #       -alias androiddebugkey -keyalg RSA -keysize 2048 \
      #       -validity 10000 -storepass android -keypass android \
      #       -dname "CN=Android Debug,O=Android,C=US"
      #
      # - name: Setup debug signing
      #   working-directory: simple_live_app/android
      #   run: |
      #     cat > key.properties <<'EOF'
      #     storeFile=app/debug.keystore
      #     storePassword=android
      #     keyPassword=android
      #     keyAlias=androiddebugkey
      #     EOF

      - name: Apply CI dependency overrides
        working-directory: simple_live_app
        run: |
          # 在 CI 中覆盖冲突依赖版本（不改仓库）
          # 1) intl 与 flutter_localizations 对齐到 0.20.2
          # 2) media_kit_video >=1.3.0（>=1.3 才不依赖旧版 screen_brightness 0.2.x）
          cat > pubspec_overrides.yaml <<'YAML'
          dependency_overrides:
            intl: 0.20.2
            media_kit_video: ">=1.3.0 <2.0.0"
          YAML
          echo "pubspec_overrides.yaml created:"
          cat pubspec_overrides.yaml

      - name: Fetch packages
        working-directory: simple_live_app
        run: |
          set -e
          flutter pub get
          echo "Resolved dependencies:"
          flutter pub deps --style=compact | sed -n '1,120p' || true

      - name: Build APK (release, arm64)
        working-directory: simple_live_app
        run: |
          flutter build apk --release --target-platform android-arm64
          echo "APK outputs:"
          find build/app/outputs -type f -name "*.apk" -printf "%p\t%k KB\n" || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: |
            simple_live_app/build/app/outputs/flutter-apk/*.apk
            simple_live_app/build/app/outputs/apk/release/*.apk
          if-no-files-found: error